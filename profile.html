<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - A5K60</title>
    <style>
        /* [GI·ªÆ NGUY√äN TO√ÄN B·ªò CSS C·ª¶A B·∫†N] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.error { background: #f44336; }
        .notification.info { background: #2196f3; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        .profile-header {
            position: relative;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
        }
        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .avatar:hover { transform: scale(1.05); }
        .edit-header-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            overflow-y: auto;
        }
        .modal-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        .close-modal:hover { color: #333; }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .photo-item:hover { transform: scale(1.05); }
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .photo-item.selected { box-shadow: 0 0 0 3px #667eea; }
        .upload-area {
            border: 2px dashed #667eea;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover { background: #f5f5ff; }
        .upload-area input[type="file"] { display: none; }
        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        .info-section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
        }
        .info-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .info-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        .info-item label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }
        .quote-section { grid-column: 1 / -1; }
        .quote-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .quote-input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
        }
        .group-section {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        .btn:hover { background: #5a6fd8; }
        .btn-secondary { background: #6c757d; }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        @media (max-width: 768px) {
            .profile-info { grid-template-columns: 1fr; }
            .quote-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- ‚úÖ N√öT ƒêƒÇNG XU·∫§T (n·∫øu c·∫ßn) -->
    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">ƒêƒÉng xu·∫•t</button>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; display: flex; justify-content: center; align-items: center;">
        <div class="loading" style="width: 50px; height: 50px;"></div>
    </div>

    <!-- ‚úÖ MAIN APP (LU√îN HI·ªÜN - KH√îNG C√ì FORM ƒêƒÇNG NH·∫¨P) -->
    <div class="container">
        <h1 style="text-align: center; color: #667eea; margin-bottom: 20px;">Trang C√° Nh√¢n</h1>
        
        <!-- Profile Header -->
        <div class="profile-header" id="profileHeader">
            <button class="edit-header-btn" onclick="openPhotoLibrary('background')">
                üì∑ ƒê·ªïi ·∫£nh n·ªÅn
            </button>
            <div class="header-overlay">
                <div class="avatar-container">
                    <img src="" alt="Avatar" class="avatar" id="profileAvatar" onclick="openPhotoLibrary('avatar')">
                    <p style="margin-top: 10px; font-size: 14px;">Click ƒë·ªÉ ƒë·ªïi avatar</p>
                </div>
                <h1 id="displayName">ƒêang t·∫£i...</h1>
                <p id="userBio">ƒêang t·∫£i...</p>
                <small id="syncStatus" style="color: #ddd;">ƒêang ƒë·ªìng b·ªô...</small>
            </div>
        </div>

        <!-- Profile Info Grid -->
        <div class="profile-info">
            <div class="info-section">
                <h2>üì∏ Th∆∞ vi·ªán c√° nh√¢n</h2>
                <div id="personalGallery" class="photo-grid">
                    <p style="grid-column: 1/-1; text-align: center; color: #999;">ƒêang t·∫£i...</p>
                </div>
                <button class="btn" onclick="openPhotoLibrary('upload')" style="margin-top: 15px; width: 100%;">
                    + Th√™m ·∫£nh m·ªõi
                </button>
            </div>

            <div class="info-section">
                <h2>üë• ·∫¢nh nh√≥m chung</h2>
                <div id="groupGallery" class="photo-grid">
                    <p style="grid-column: 1/-1; text-align: center; color: #999;">ƒêang t·∫£i...</p>
                </div>
                <button class="btn" onclick="uploadGroupMedia()" style="margin-top: 15px; width: 100%;">
                    + Chia s·∫ª ·∫£nh/video nh√≥m
                </button>
            </div>

            <div class="info-section">
                <h2>üîó Li√™n k·∫øt & Nh√≥m</h2>
                <div class="info-item">
                    <label>üìò Facebook</label>
                    <div id="facebookLink">ƒêang t·∫£i...</div>
                </div>
                <div class="info-item">
                    <label>üì∑ Instagram</label>
                    <div id="instagramLink">ƒêang t·∫£i...</div>
                </div>
                <div class="info-item">
                    <label>üîí Locket</label>
                    <div id="locketLink">ƒêang t·∫£i...</div>
                </div>
                <button class="btn" onclick="openEditModal()" style="margin-top: 15px; width: 100%;">
                    ‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin
                </button>
            </div>

            <div class="info-section">
                <h2>‚ù§Ô∏è S·ªü th√≠ch</h2>
                <div id="hobbiesList">
                    <p style="color: #999;">ƒêang t·∫£i...</p>
                </div>
            </div>

            <div class="info-section quote-section">
                <h2>üéØ Th√¥ng tin c√° nh√¢n</h2>
                <div class="quote-container">
                    <div>
                        <label style="font-weight: bold; color: #667eea; margin-bottom: 10px; display: block;">C√¢u n√≥i y√™u th√≠ch</label>
                        <textarea id="favoriteQuote" class="quote-input" rows="3" readonly>ƒêang t·∫£i...</textarea>
                        <button class="btn" onclick="editQuote()" style="margin-top: 10px;">‚úèÔ∏è S·ª≠a</button>
                    </div>
                    <div class="group-section">
                        <label style="font-weight: bold; color: #667eea; margin-bottom: 10px; display: block;">üë• Qu·∫£n l√Ω nh√≥m</label>
                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">T·∫°o nh√≥m v√† chia s·∫ª d·ªØ li·ªáu v·ªõi th√†nh vi√™n</p>
                        <button class="btn" onclick="createNewGroup()" style="width: 100%; margin-bottom: 10px;">+ T·∫°o nh√≥m m·ªõi</button>
                        <button class="btn btn-secondary" onclick="shareData()" style="width: 100%;">üì§ Chia s·∫ª d·ªØ li·ªáu</button>
                        <div id="groupList" style="margin-top: 15px;">
                            <!-- Danh s√°ch nh√≥m -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Photo Library & Edit) -->
    <div id="photoLibraryModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePhotoLibrary()">&times;</span>
            <h2>üì∏ Th∆∞ vi·ªán ·∫£nh</h2>
            <div class="upload-area" onclick="document.getElementById('photoUpload').click()">
                <h3>+ Click ƒë·ªÉ t·∫£i ·∫£nh l√™n</h3>
                <p>·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firebase (n√©n t·ª± ƒë·ªông)</p>
            </div>
            <input type="file" id="photoUpload" accept="image/*" multiple onchange="uploadPhotos(event)">
            <div id="libraryPhotos" class="photo-grid"></div>
            <button class="btn" id="selectPhotoBtn" onclick="selectPhotoForPurpose()" style="margin-top: 20px; display: none;">
                Ch·ªçn ·∫£nh
            </button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n</h2>
            <form class="edit-form" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label>T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="editBio" rows="3"></textarea>
                </div>
                <!-- ... (c√°c field kh√°c gi·ªØ nguy√™n) ... -->
                <button type="submit" class="btn" style="width: 100%;">üíæ L∆∞u thay ƒë·ªïi</button>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            serverTimestamp,
            query,
            where,
            addDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAbD9ave4WUPk9MndVZ7_3_f5XyhNVepEY",
            authDomain: "a5k60-website.firebaseapp.com",
            databaseURL: "https://a5k60-website-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "a5k60-website",
            storageBucket: "a5k60-website.firebasestorage.app",
            messagingSenderId: "1083754554024",
            appId: "1:1083754554024:web:6847ea23b19a9369dc989d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.app = app;
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.where = where;
        window.addDoc = addDoc;
    </script>

    <!-- Main JS -->
    <script type="module">
        const { 
            app, db, collection, doc, getDoc, setDoc, 
            onSnapshot, serverTimestamp, query, where, addDoc
        } = window;

        let currentUser = null;
        let userId = null;
        let profileUnsubscribe = null;
        let groupsUnsubscribe = null;

        // ‚úÖ T·ª∞ ƒê·ªòNG L·∫§Y USER T·ª™ LOCALSTORAGE (KH√îNG C·∫¶N ƒêƒÇNG NH·∫¨P)
        document.addEventListener('DOMContentLoaded', async () => {
            const savedUser = localStorage.getItem('currentUser');
            if (!savedUser) {
                showNotification('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng quay l·∫°i trang ƒëƒÉng nh·∫≠p.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html'; // Ho·∫∑c trang login c·ªßa b·∫°n
                }, 2000);
                return;
            }

            currentUser = JSON.parse(savedUser);
            userId = currentUser.memberId;
            
            // Load profile t·ª´ Firestore
            await loadProfileFromFirebase();
            setupRealTimeListeners();
        });

        // REAL-TIME LISTENER
        function setupRealTimeListeners() {
            if (!userId) return;

            const profileRef = doc(db, 'profiles', userId);
            profileUnsubscribe = onSnapshot(profileRef, (doc) => {
                if (doc.exists()) {
                    window.profileData = doc.data();
                    loadProfile();
                    document.getElementById('syncStatus').textContent = '‚úì ƒê·ªìng b·ªô th√†nh c√¥ng';
                }
            });

            const groupsRef = collection(db, 'groups');
            const userGroupsQuery = query(groupsRef, where('members', 'array-contains', userId));
            groupsUnsubscribe = onSnapshot(userGroupsQuery, (snapshot) => {
                window.profileData.groups = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateGroupList();
            });
        }

        // T·∫¢I PROFILE T·ª™ FIRESTORE
        async function loadProfileFromFirebase() {
            if (!userId) return;

            try {
                const profileRef = doc(db, 'profiles', userId);
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists()) {
                    window.profileData = profileSnap.data();
                } else {
                    // Kh·ªüi t·∫°o profile m·ªõi t·ª´ users.json
                    const response = await fetch('users.json');
                    const data = await response.json();
                    const user = data.users[userId];
                    
                    window.profileData = {
                        name: user ? user.name : 'Ng∆∞·ªùi d√πng m·ªõi',
                        bio: 'Ch∆∞a c√≥ ti·ªÉu s·ª≠',
                        avatar: user ? user.avatar : '',
                        background: '',
                        photos: [],
                        groupPhotos: [],
                        facebook: '',
                        instagram: '',
                        locket: '',
                        hobbies: [],
                        favoriteQuote: '"Life is what happens when you\'re busy making other plans."',
                        groups: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    await setDoc(profileRef, window.profileData);
                }
                
                loadProfile();
            } catch (error) {
                console.error("‚ùå Load profile error:", error);
                showNotification('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
                document.getElementById('syncStatus').textContent = '‚úó L·ªói ƒë·ªìng b·ªô';
            }
        }

        // L∆ØU PROFILE V√ÄO FIRESTORE
        async function saveProfileToFirebase() {
            if (!userId || !window.profileData) return false;

            try {
                window.profileData.updatedAt = serverTimestamp();
                const profileRef = doc(db, 'profiles', userId);
                await setDoc(profileRef, window.profileData, { merge: true });
                return true;
            } catch (error) {
                console.error("‚ùå Save profile error:", error);
                showNotification('L·ªói l∆∞u d·ªØ li·ªáu: ' + error.message, 'error');
                return false;
            }
        }

        // C√ÅC H√ÄM KH√ÅC (gi·ªØ nguy√™n logic)
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function loadProfile() {
            if (!window.profileData) return;
            
            const data = window.profileData;
            
            if (data.background) {
                document.getElementById('profileHeader').style.backgroundImage = `url(${data.background})`;
            }
            document.getElementById('profileAvatar').src = data.avatar || 
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI2MCIgY3k9IjYwIiByPSI2MCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjYwIiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij7wn5OOPC90ZXh0Pjwvc3ZnPg==';
            document.getElementById('displayName').textContent = data.name || 'Ch∆∞a c√≥ t√™n';
            document.getElementById('userBio').textContent = data.bio || 'Ch∆∞a c√≥ ti·ªÉu s·ª≠';
            document.getElementById('favoriteQuote').value = data.favoriteQuote || '';
            
            document.getElementById('facebookLink').innerHTML = 
                data.facebook ? `<a href="${data.facebook}" target="_blank">${data.facebook}</a>` : 'Ch∆∞a c·∫≠p nh·∫≠t';
            
            updatePhotoGallery();
            updateGroupGallery();
            updateGroupList();
        }

        // ... (c√°c h√†m kh√°c: openPhotoLibrary, compressImage, uploadPhotos, v.v.) ...

    </script>
</body>
</html>
