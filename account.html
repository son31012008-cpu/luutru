<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A5K60 - C√†i ƒë·∫∑t t√†i kho·∫£n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Inter', 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #FAF7F0 0%, #F0EDE6 100%); min-height: 100vh; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .content-section { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 1.5rem; transition: all 0.3s ease; }
        .content-section:hover { background: rgba(255, 255, 255, 0.95); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .form-input { background: rgba(250, 247, 240, 0.8); border: 2px solid transparent; transition: all 0.3s ease; }
        .form-input:focus { background: rgba(255, 255, 255, 0.9); border-color: #E17055; box-shadow: 0 0 0 4px rgba(225, 112, 85, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #E17055 0%, #D63031 100%); color: white; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(225, 112, 85, 0.3); }
        .btn-secondary { background: rgba(52, 152, 219, 0.1); color: #3498db; border: 1px solid rgba(52, 152, 219, 0.2); transition: all 0.3s ease; }
        .btn-secondary:hover { background: #3498db; color: white; }
        .btn-danger { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.2); transition: all 0.3s ease; }
        .btn-danger:hover { background: #e74c3c; color: white; }
        
        /* Notification Toast Styles */
        .notification {
            position: fixed;
            top: 5rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-left: 4px solid;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 20rem;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 1.7s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .notification.info { border-color: #3498db; }
        .notification.success { border-color: #2ecc71; }
        .notification.warning { border-color: #f39c12; }
        .notification.error { border-color: #e74c3c; }
        .notification-icon { margin-right: 0.75rem; font-size: 1.25rem; }
        .notification-message { color: #2c3e50; font-weight: 500; }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar fixed top-0 left-0 right-0 z-50 px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <button id="backBtn" class="btn-secondary px-3 py-2 rounded-lg text-sm font-medium">
                    ‚Üê Quay l·∫°i
                </button>
                <div class="text-2xl">üêí</div>
                <h1 class="text-xl font-bold text-gray-800">A5K60</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="hidden md:block">
                    <span class="text-sm text-gray-600">C√†i ƒë·∫∑t t√†i kho·∫£n</span>
                </div>
                <button id="logoutBtn" class="btn-danger px-4 py-2 rounded-lg text-sm font-medium">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Notification Toast -->
    <div id="notification" class="notification hidden">
        <div class="flex items-center">
            <div id="notificationIcon" class="notification-icon"></div>
            <div id="notificationMessage" class="notification-message"></div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="pt-20 px-4 pb-8">
        <div class="max-w-2xl mx-auto">
            <!-- Account Settings -->
            <section class="content-section p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">‚öôÔ∏è C√†i ƒë·∫∑t t√†i kho·∫£n</h2>
                
                <!-- Email Verification Section -->
                <div id="emailSection" class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üîí X√°c th·ª±c email</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800">‚ö†Ô∏è B·∫°n c·∫ßn x√°c th·ª±c email ƒë·ªÉ thay ƒë·ªïi th√¥ng tin t√†i kho·∫£n.</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email c·ªßa b·∫°n</label>
                            <input type="email" id="userEmail" class="form-input w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="your.email@gmail.com">
                        </div>
                        <button id="verifyEmailBtn" class="btn-primary px-6 py-3 rounded-xl text-sm font-medium w-full">
                            G·ª≠i link x√°c th·ª±c
                        </button>
                    </div>
                </div>
                
                <!-- Change Password Section (·∫®n m·∫∑c ƒë·ªãnh) -->
                <div id="passwordSection" class="mb-8 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üîë Thay ƒë·ªïi m·∫≠t kh·∫©u</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="newPassword" class="form-input w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                            <input type="password" id="confirmPassword" class="form-input w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
                        </div>
                        <button id="changePasswordBtn" class="btn-primary px-6 py-3 rounded-xl text-sm font-medium w-full">
                            C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                        </button>
                    </div>
                </div>
                
                <!-- Change Username Section (·∫®n m·∫∑c ƒë·ªãnh) -->
                <div id="usernameSection" class="mb-8 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">üë§ Thay ƒë·ªïi t√™n ng∆∞·ªùi d√πng</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ng∆∞·ªùi d√πng m·ªõi</label>
                            <input type="text" id="newUsername" class="form-input w-full px-4 py-3 rounded-xl focus:outline-none" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng m·ªõi">
                        </div>
                        <button id="changeUsernameBtn" class="btn-primary px-6 py-3 rounded-xl text-sm font-medium w-full">
                            C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
                        </button>
                    </div>
                </div>
                
                <!-- Verified Status -->
                <div id="verifiedSection" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center">
                            <div class="text-green-500 text-xl mr-3">‚úÖ</div>
                            <div>
                                <h4 class="font-semibold text-green-800">Email ƒë√£ x√°c th·ª±c</h4>
                                <p class="text-sm text-green-700" id="verifiedEmail">email@example.com</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAbD9ave4WUPk9MndVZ7_3_f5XyhNVepEY",
            authDomain: "a5k60-website.firebaseapp.com",
            databaseURL: "https://a5k60-website-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "a5k60-website",
            storageBucket: "a5k60-website.firebasestorage.app",
            messagingSenderId: "1083754554024",
            appId: "1:1083754554024:web:6847ea23b19a9369dc989d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        let currentUser = null;
        let isEmailVerified = false;
        
        // H√†m hi·ªÉn th·ªã th√¥ng b√°o t·ª± ƒë·ªông ·∫©n sau 2 gi√¢y
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationMessage = document.getElementById('notificationMessage');
            
            const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
            notificationIcon.textContent = icons[type] || icons.info;
            notificationMessage.textContent = message;
            
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 2000);
        }
        
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return null;
            }
            return JSON.parse(user);
        }
        
        // G·ª≠i email x√°c th·ª±c
        async function sendVerificationEmail() {
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                showNotification('Vui l√≤ng nh·∫≠p email!', 'warning');
                return;
            }
            
            if (!email.endsWith('@gmail.com')) {
                showNotification('Ch·ªâ ch·∫•p nh·∫≠n email Gmail!', 'warning');
                return;
            }
            
            try {
                showNotification('ƒêang g·ª≠i email x√°c th·ª±c...', 'info');
                
                // S·ª¨A ƒê√ÇY: ƒê∆°n gi·∫£n h√≥a actionCodeSettings, ch·ªâ gi·ªØ l·∫°i 2 tr∆∞·ªùng b·∫Øt bu·ªôc
                const actionCodeSettings = {
                    url: window.location.origin + '/account.html?verified=true',
                    handleCodeInApp: true
                };
                
                // L∆∞u email v√†o localStorage ƒë·ªÉ x√°c th·ª±c sau
                localStorage.setItem('pendingEmail', email);
                
                // G·ª≠i email x√°c th·ª±c
                await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                
                showNotification('ƒê√£ g·ª≠i link x√°c th·ª±c ƒë·∫øn ' + email, 'success');
                
                // ·∫®n n√∫t g·ª≠i v√† hi·ªán h∆∞·ªõng d·∫´n
                document.getElementById('verifyEmailBtn').textContent = 'ƒê√£ g·ª≠i! Ki·ªÉm tra email c·ªßa b·∫°n';
                document.getElementById('verifyEmailBtn').disabled = true;
                
            } catch (error) {
                console.error('L·ªói g·ª≠i email:', error);
                showNotification('L·ªói: ' + error.message, 'error');
            }
        }
        
        // X·ª≠ l√Ω x√°c th·ª±c email khi quay l·∫°i t·ª´ link
        async function handleEmailVerification() {
            if (auth.isSignInWithEmailLink(window.location.href)) {
                try {
                    const email = localStorage.getItem('pendingEmail');
                    if (!email) {
                        showNotification('Kh√¥ng t√¨m th·∫•y email ƒë·ªÉ x√°c th·ª±c!', 'error');
                        return;
                    }
                    
                    await auth.signInWithEmailLink(email, window.location.href);
                    
                    // X√≥a email ƒë√£ x√°c th·ª±c
                    localStorage.removeItem('pendingEmail');
                    
                    showNotification('‚úÖ X√°c th·ª±c email th√†nh c√¥ng!', 'success');
                    
                    // C·∫≠p nh·∫≠t UI
                    document.getElementById('emailSection').classList.add('hidden');
                    document.getElementById('verifiedSection').classList.remove('hidden');
                    document.getElementById('passwordSection').classList.remove('hidden');
                    document.getElementById('usernameSection').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('L·ªói x√°c th·ª±c:', error);
                    showNotification('L·ªói x√°c th·ª±c: ' + error.message, 'error');
                }
            }
        }
        
        // Thay ƒë·ªïi m·∫≠t kh·∫©u
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword.length < 6) {
                showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('M·∫≠t kh·∫©u kh√¥ng kh·ªõp!', 'warning');
                return;
            }
            
            try {
                showNotification('ƒêang c·∫≠p nh·∫≠t m·∫≠t kh·∫©u...', 'info');
                
                // C·∫≠p nh·∫≠t trong Firebase Database
                await db.ref(`users/${currentUser.memberId}/password`).set(newPassword);
                
                // C·∫≠p nh·∫≠t trong localStorage
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showNotification('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
                
                // X√≥a form
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
            } catch (error) {
                console.error('L·ªói ƒë·ªïi m·∫≠t kh·∫©u:', error);
                showNotification('L·ªói: ' + error.message, 'error');
            }
        }
        
        // Thay ƒë·ªïi t√™n ng∆∞·ªùi d√πng
        async function changeUsername() {
            const newUsername = document.getElementById('newUsername').value.trim();
            
            if (!newUsername) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng!', 'warning');
                return;
            }
            
            if (newUsername.length < 3) {
                showNotification('T√™n ng∆∞·ªùi d√πng ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!', 'warning');
                return;
            }
            
            try {
                showNotification('ƒêang c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng...', 'info');
                
                // C·∫≠p nh·∫≠t trong Firebase Database
                await db.ref(`users/${currentUser.memberId}/name`).set(newUsername);
                
                // C·∫≠p nh·∫≠t trong localStorage
                currentUser.name = newUsername;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showNotification('‚úÖ ƒê·ªïi t√™n ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
                
                // X√≥a form
                document.getElementById('newUsername').value = '';
                
            } catch (error) {
                console.error('L·ªói ƒë·ªïi t√™n:', error);
                showNotification('L·ªói: ' + error.message, 'error');
            }
        }
        
        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = checkAuth();
            if (!currentUser) return;
            
            // Ki·ªÉm tra x√°c th·ª±c email t·ª´ URL
            handleEmailVerification();
            
            // Hi·ªÉn th·ªã email n·∫øu ƒë√£ x√°c th·ª±c
            const pendingEmail = localStorage.getItem('pendingEmail');
            if (pendingEmail) {
                document.getElementById('userEmail').value = pendingEmail;
            }
            
            // Load th√¥ng tin ng∆∞·ªùi d√πng
            const userSnapshot = await db.ref(`users/${currentUser.memberId}`).once('value');
            const userData = userSnapshot.val();
            
            if (userData?.verifiedEmail) {
                isEmailVerified = true;
                document.getElementById('emailSection').classList.add('hidden');
                document.getElementById('verifiedSection').classList.remove('hidden');
                document.getElementById('verifiedEmail').textContent = userData.verifiedEmail;
                document.getElementById('passwordSection').classList.remove('hidden');
                document.getElementById('usernameSection').classList.remove('hidden');
            }
            
            // Event listeners
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('pendingEmail');
                window.location.href = 'login.html';
            });
            
            document.getElementById('verifyEmailBtn').addEventListener('click', sendVerificationEmail);
            document.getElementById('changePasswordBtn').addEventListener('click', changePassword);
            document.getElementById('changeUsernameBtn').addEventListener('click', changeUsername);
        });
    </script>
</body>
</html>
